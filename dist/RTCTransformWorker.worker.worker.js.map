{"version":3,"file":"RTCTransformWorker.worker.worker.js","mappings":"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","sources":["webpack://OvenPlayer/./src/js/api/worker/RTCTransformWorker.worker.js"],"sourcesContent":["/**\r\n * Created by rock on 2025. 2\r\n */\r\n\r\nconst OVENMEDIAENGINE_SEI_METADATA_UUID = '464d4c475241494e434f4c4f55524201';\r\n\r\nfunction removeEmulationPreventionBytes(data) {\r\n  const rbsp = [];\r\n  for (let i = 0; i < data.length; i++) {\r\n\r\n    if (i > 2 && data[i - 2] === 0x00 && data[i - 1] === 0x00 && data[i] === 0x03) {\r\n      continue; // skip 0x03\r\n    }\r\n    rbsp.push(data[i]);\r\n  }\r\n  return new Uint8Array(rbsp);\r\n}\r\n\r\nfunction parseSEIPayload(rbsp) {\r\n\r\n  const messages = [];\r\n\r\n  let i = 0;\r\n  const rbspLength = rbsp[rbsp.length - 1] === 0x80 ? rbsp.length - 1 : rbsp.length;\r\n\r\n  while (i < rbspLength) {\r\n\r\n    let type = 0;\r\n    while (rbsp[i] === 0xFF) {\r\n      type += 255;\r\n      i++;\r\n    }\r\n    type += rbsp[i++];\r\n\r\n    let size = 0;\r\n    while (rbsp[i] === 0xFF) {\r\n      size += 255;\r\n      i++;\r\n    }\r\n    size += rbsp[i++];\r\n\r\n    const payload = rbsp.slice(i, i + size);\r\n    i += size;\r\n\r\n    messages.push({ type, size, payload });\r\n\r\n    return { type, size, payload };\r\n  }\r\n\r\n  return messages;\r\n}\r\n\r\nfunction toHexString(byteArray, delimiter = '') {\r\n  return Array.from(byteArray, byte => {\r\n    return ('0' + (byte & 0xFF).toString(16)).slice(-2);\r\n  }).join(delimiter);\r\n}\r\n\r\nfunction toHexArray(byteArray) {\r\n  return Array.from(byteArray, byte => {\r\n    return ('0' + (byte & 0xFF).toString(16)).slice(-2);\r\n  });\r\n}\r\n\r\nfunction toUUID(byteArray) {\r\n  const hexString = toHexString(byteArray);\r\n  return [\r\n    hexString.slice(0, 8),\r\n    hexString.slice(8, 12),\r\n    hexString.slice(12, 16),\r\n    hexString.slice(16, 20),\r\n    hexString.slice(20, 24),\r\n    hexString.slice(24, 32)\r\n  ].join('-');\r\n}\r\n\r\nfunction toTimestamp(byteArray) {\r\n  const hexString = toHexString(byteArray);\r\n  return parseInt(hexString, 16);\r\n}\r\n\r\nfunction toAsciiString(byteArray) {\r\n  return String.fromCharCode.apply(null, byteArray);\r\n}\r\n\r\nfunction findNalStartIndex(frameData, offset) {\r\n  while (offset < frameData.byteLength - 4) {\r\n    if ((frameData[offset] === 0x00 && frameData[offset + 1] === 0x00)\r\n      && (frameData[offset + 2] === 0x01 || (frameData[offset + 2] === 0x00 && frameData[offset + 3] === 0x01))) {\r\n      return offset;\r\n    } else {\r\n      offset += 1;\r\n    }\r\n  }\r\n  return -1;\r\n}\r\n\r\nfunction getNalus(frameData) {\r\n\r\n  let offset = 0;\r\n  const headerSize = 1;\r\n  const nalus = [];\r\n\r\n  while (offset < frameData.byteLength - 4) {\r\n\r\n    const startCodeIndex = findNalStartIndex(frameData, offset);\r\n\r\n    if (startCodeIndex >= offset) {\r\n\r\n      const startCodeLength = frameData[startCodeIndex + 2] === 0x01 ? 3 : 4;\r\n      const nextStartCodeIndex = findNalStartIndex(frameData, startCodeIndex + startCodeLength + headerSize);\r\n\r\n      if (nextStartCodeIndex > startCodeIndex) {\r\n\r\n        nalus.push(frameData.subarray(startCodeIndex, nextStartCodeIndex));\r\n        offset = nextStartCodeIndex;\r\n      } else {\r\n\r\n        nalus.push(frameData.subarray(startCodeIndex));\r\n        break;\r\n      }\r\n    } else {\r\n      break;\r\n    }\r\n  }\r\n  return nalus;\r\n}\r\n\r\nfunction createReceiverTransform() {\r\n  return new TransformStream({\r\n    start() { },\r\n    flush() { },\r\n    async transform(encodedFrame, controller) {\r\n\r\n      const nalus = getNalus(new Uint8Array(encodedFrame.data));\r\n\r\n      nalus.forEach((nalu) => {\r\n\r\n        const startCodeLength = nalu[2] === 0x01 ? 3 : 4;\r\n        const headerCodeLength = 1;\r\n        const nalHeader = nalu[startCodeLength];\r\n        const nalType = nalHeader & 0x1F;\r\n\r\n        // NAL Type SEI\r\n        if (nalType === 6) {\r\n\r\n          const rbsp = removeEmulationPreventionBytes(nalu.subarray(startCodeLength + headerCodeLength));\r\n\r\n          const parsedSei = parseSEIPayload(rbsp);\r\n\r\n          const eventData = {\r\n            nalu: nalu,\r\n            sei: parsedSei\r\n          };\r\n\r\n          const uuid = toHexString(parsedSei.payload.subarray(0, 16));\r\n\r\n          if (uuid === OVENMEDIAENGINE_SEI_METADATA_UUID) {\r\n\r\n            postMessage({\r\n              action: 'sei', data: {\r\n                ...eventData,\r\n                registered: true,\r\n                uuid: toUUID(parsedSei.payload.subarray(0, 16)),\r\n                timecode: toTimestamp(parsedSei.payload.subarray(16, 24)),\r\n                userdata: parsedSei.payload.subarray(24)\r\n              }\r\n            });\r\n          } else {\r\n\r\n            postMessage({\r\n              action: 'sei', data: {\r\n                ...eventData,\r\n                registered: false\r\n              }\r\n            });\r\n          }\r\n        }\r\n      });\r\n\r\n      controller.enqueue(encodedFrame);\r\n    }\r\n  })\r\n}\r\n\r\nfunction setupPipe({ readable, writable }, transform) {\r\n  readable\r\n    .pipeThrough(transform)\r\n    .pipeTo(writable)\r\n}\r\n\r\naddEventListener('rtctransform', (event) => {\r\n  setupPipe(event.transformer, createReceiverTransform());\r\n});\r\n\r\naddEventListener('message', (event) => {\r\n  const { action } = event.data;\r\n\r\n  switch (action) {\r\n    case 'rtctransform':\r\n      setupPipe(event.data, createReceiverTransform())\r\n      break;\r\n    default:\r\n      break;\r\n  }\r\n});\r\n"],"names":["toHexString","byteArray","delimiter","Array","from","byte","toString","slice","join","toUUID","hexString","toTimestamp","parseInt","findNalStartIndex","frameData","offset","byteLength","createReceiverTransform","TransformStream","start","flush","transform","encodedFrame","controller","nalus","startCodeIndex","nextStartCodeIndex","push","subarray","getNalus","Uint8Array","data","forEach","nalu","startCodeLength","parsedSei","rbsp","messages","i","rbspLength","length","type","size","payload","parseSEIPayload","removeEmulationPreventionBytes","eventData","sei","postMessage","action","registered","uuid","timecode","userdata","enqueue","setupPipe","readable","writable","pipeThrough","pipeTo","addEventListener","event","transformer"],"sourceRoot":""}